<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DMC Content Manager – Page 1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- External CSS hosted in CloudPages -->
    <link
      rel="stylesheet"
      href="https://mcf3ylxg67h42hhkc8yccdpmdjt1.pub.sfmc-content.com/xos4rfhkxdn"
    />
  </head>
  <body>
  %%[
  /* Querystring params */
  VAR @selectedCategoryId,
      @selectedDataExtensionKey

  SET @selectedCategoryId       = RequestParameter("cat")
  SET @selectedDataExtensionKey = RequestParameter("de")

  /* soft-delete flags for variants */
  VAR @deleteFlag,
      @delCountry,
      @delLang,
      @delType,
      @delVersion,
      @rowsUpdated

  SET @deleteFlag = RequestParameter("delete")
  SET @delCountry = RequestParameter("country")
  SET @delLang    = RequestParameter("lang")
  SET @delType    = RequestParameter("type")
  SET @delVersion = RequestParameter("version")

  /* If delete=1 and we know which DE + row, set Status = Deleted */
  IF NOT EMPTY(@selectedDataExtensionKey) AND @deleteFlag == "1" THEN

    /* 4 keys: CountryCode + LanguageCode + Type + Version */
    SET @rowsUpdated = UpdateData(
      @selectedDataExtensionKey,
      4,
      "CountryCode",  @delCountry,
      "LanguageCode", @delLang,
      "Type",         @delType,
      "Version",      @delVersion,
      "Status",       "Deleted"
    )

  ENDIF

  /* Category nav data */
  VAR @categoryRows,
      @categoryRowCount,
      @index,
      @categoryRow,
      @categoryId,
      @categoryName,
      @activeClass,
      @selectedCategoryName

  SET @categoryRows = LookupOrderedRows(
    "CM_ContentCategory",
    0,
    "CreatedDate ASC",
    "Status",
    "Active"
  )
  SET @categoryRowCount = RowCount(@categoryRows)

  IF NOT EMPTY(@selectedCategoryId) THEN
    SET @selectedCategoryName = Lookup(
      "CM_ContentCategory",
      "CategoryName",
      "CategoryId",
      @selectedCategoryId
    )
  ENDIF

  /* Content-DataExtension list - when a category is selected
     and no data extension is selected yet */
  VAR @contentRows,
      @contentRowCount,
      @contentIndex,
      @contentRow,
      @dataExtensionKey

  IF NOT EMPTY(@selectedCategoryId) AND EMPTY(@selectedDataExtensionKey) THEN

    SET @contentRows = LookupOrderedRows(
      "CM_ContentDataExtension",
      0,
      "CreatedDate ASC",
      "Status", "Active",
      "CategoryId", @selectedCategoryId
    )
    SET @contentRowCount = RowCount(@contentRows)
  ENDIF

  /* Variant list after selecting a content */
  VAR @variantRows,
      @variantRowCount,
      @variantIndex,
      @variantRow,
      @countryCode,
      @languageCode,
      @variantType,
      @variantVersion

  IF NOT EMPTY(@selectedDataExtensionKey) THEN

    /* Show only active rows for this content block. */
    SET @variantRows = LookupOrderedRows(
      @selectedDataExtensionKey,
      0,
      "CountryCode ASC, LanguageCode ASC, Type ASC, Version ASC",
      "Status", "Active"
    )
    SET @variantRowCount = RowCount(@variantRows)
  ENDIF
]%%


    <header class="top-bar">DMC</header>

    <div class="app">
      <!-- LEFT NAV -->
      <aside class="sidebar">
        <nav class="nav">
          %%[ IF @categoryRowCount > 0 THEN
               FOR @index = 1 TO @categoryRowCount DO
                 SET @categoryRow  = Row(@categoryRows, @index)
                 SET @categoryId   = Field(@categoryRow, "CategoryId")
                 SET @categoryName = Field(@categoryRow, "CategoryName")

                 IF NOT EMPTY(@selectedCategoryId) AND @categoryId == @selectedCategoryId THEN
                   SET @activeClass = " active"
                 ELSE
                   SET @activeClass = ""
                 ENDIF
          ]%%
          <a href="?cat=%%=v(@categoryId)=%%"
             class="nav-link%%=v(@activeClass)=%%">
            %%=v(@categoryName)=%%
          </a>
          %%[    NEXT @index
              ENDIF
          ]%%
        </nav>
      </aside>

      <!-- MAIN CARD -->
      <main class="main">
        <section class="card">
          %%[ IF NOT EMPTY(@selectedDataExtensionKey) THEN ]%%
            <!-- AFTER SELECTING A CONTENT (variants list) -->

            <h1 class="card-title">
              %%[ IF NOT EMPTY(@selectedCategoryName) THEN ]%%
                %%=v(@selectedCategoryName)=%% - %%=v(@selectedDataExtensionKey)=%%
              %%[ ELSE ]%%
                %%=v(@selectedDataExtensionKey)=%%
              %%[ ENDIF ]%%
            </h1>

            <div style="text-align: right; margin-bottom: 0.5rem;">
              <a
                href="%%=IIF(EMPTY(@selectedCategoryId),'?',Concat('?cat=',@selectedCategoryId))=%%"
                class="btn-link"
              >
                ↩ zurück
              </a>
            </div>

            <table class="list" style="margin-bottom: 1rem;">
              <tbody>
                <tr>
                  <th>Data Extension:</th>
                  <td>%%=v(@selectedDataExtensionKey)=%%</td>
                </tr>
              </tbody>
            </table>

            <!-- Main variants grid -->
            <table class="list">
              <thead>
                <tr>
                  <th>Land</th>
                  <th>Sprache</th>
                  <th>Typ</th>
                  <th>Version</th>
                  <th class="actions">Action</th>
                </tr>
              </thead>
              <tbody>
                %%[ IF @variantRowCount > 0 THEN
                     FOR @variantIndex = 1 TO @variantRowCount DO
                       SET @variantRow     = Row(@variantRows, @variantIndex)
                       SET @countryCode    = Field(@variantRow, "CountryCode")
                       SET @languageCode   = Field(@variantRow, "LanguageCode")
                       SET @variantType    = Field(@variantRow, "Type")
                       SET @variantVersion = Field(@variantRow, "Version")
                ]%%
                  <tr>
                    <td>%%=v(@countryCode)=%%</td>
                    <td>%%=v(@languageCode)=%%</td>
                    <td>%%=v(@variantType)=%%</td>
                    <td>%%=v(@variantVersion)=%%</td>
                    <td class="actions">
                      <button class="btn-link">edit</button>
                      <button class="btn-link">view</button>
                      <!-- soft delete with confirm -->
                      <a
                        class="btn-link"
                        href="?cat=%%=v(@selectedCategoryId)=%%&de=%%=v(@selectedDataExtensionKey)=%%&delete=1&country=%%=v(@countryCode)=%%&lang=%%=v(@languageCode)=%%&type=%%=v(@variantType)=%%&version=%%=v(@variantVersion)=%%"
                        onclick="return confirm('Do you really want to delete this variant?');"
                      >
                        delete
                      </a>
                    </td>
                  </tr>
                %%[ NEXT @variantIndex ELSE ]%%
                  <tr>
                    <td colspan="5">No active variants found.</td>
                  </tr>
                %%[ ENDIF ]%%
              </tbody>
            </table>

          %%[ ELSE ]%%
            <!-- INITIAL STATE / CONTENT-DE LIST FOR CATEGORY   -->

            <h1 class="card-title">
              %%[ IF NOT EMPTY(@selectedCategoryName) THEN ]%%
                %%=v(@selectedCategoryName)=%%
              %%[ ELSE ]%%
                Select a category
              %%[ ENDIF ]%%
            </h1>

            %%[ IF NOT EMPTY(@selectedCategoryId) THEN ]%%
              <!-- Only show the table once a category is chosen -->
              <table class="list">
                <thead>
                  <tr>
                    <th>Data Extension</th>
                    <th class="actions">Action</th>
                  </tr>
                </thead>
                <tbody>
                  %%[ IF @contentRowCount > 0 THEN
                       FOR @contentIndex = 1 TO @contentRowCount DO
                         SET @contentRow       = Row(@contentRows, @contentIndex)
                         SET @dataExtensionKey = Field(@contentRow, "DataExtensionKey")
                  ]%%
                    <tr>
                      <td>
                        <a href="?cat=%%=v(@selectedCategoryId)=%%&de=%%=v(@dataExtensionKey)=%%">
                          %%=v(@dataExtensionKey)=%%
                        </a>
                      </td>
                      <td class="actions">
                        <button class="btn-link">✏️</button>
                      </td>
                    </tr>
                  %%[ NEXT @contentIndex ELSE ]%%
                    <tr>
                      <td colspan="2">
                        No content data extensions found for this category.
                      </td>
                    </tr>
                  %%[ ENDIF ]%%
                </tbody>
              </table>
            %%[ ELSE ]%%
              <!-- First load, no category yet -->
              <p>Please select a category from the left to see its content data extensions.</p>
            %%[ ENDIF ]%%

          %%[ ENDIF ]%%
        </section>
      </main>
    </div>
  </body>
</html>
