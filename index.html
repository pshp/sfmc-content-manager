<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DMC Content Manager â€“ Page 1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <link rel="stylesheet" href="styles.css" /> -->
    <link
      rel="stylesheet"
      href="https://mcf3ylxg67h42hhkc8yccdpmdjt1.pub.sfmc-content.com/xos4rfhkxdn"
    />
  </head>
  <body>
    %%[
      /* Get selected category from querystring */
      VAR @selectedCategoryId,
          @categoryRows,
          @categoryRowCount,
          @index,
          @categoryRow,
          @categoryId,
          @categoryName,
          @activeClass,
          @selectedCategoryName,

          @contentRows,
          @contentRowCount,
          @contentIndex,
          @contentRow,
          @dataExtensionKey,
          @contentCategoryId

      /* ?cat=newsletter or ?cat=static_content, etc. */
      SET @selectedCategoryId = RequestParameter("cat")

      /* Load all active categories ordered by CreatedDate ASC */
      SET @categoryRows = LookupOrderedRows(
        "CM_ContentCategory",
        0,
        "CreatedDate ASC",
        "IsActive",
        "True"
      )
      SET @categoryRowCount = RowCount(@categoryRows)

      /* Load content DE mappings
        - if a category is selected, filter by CategoryId
        - if not, show all active rows */
      IF NOT EMPTY(@selectedCategoryId) THEN

        SET @selectedCategoryName = Lookup(
          "CM_ContentCategory",
          "CategoryName",
          "CategoryId",
          @selectedCategoryId
        )

        SET @contentRows = LookupOrderedRows(
          "CM_ContentDataExtension",
          0,
          "CreatedDate ASC",
          "IsActive", "True",
          "CategoryId", @selectedCategoryId
        )
      ELSE
        /* No category selected: show all active content DEs */
        SET @contentRows = LookupOrderedRows(
          "CM_ContentDataExtension",
          0,
          "CreatedDate ASC",
          "IsActive", "True"
        )
      ENDIF

      SET @contentRowCount = RowCount(@contentRows)
    ]%%

    <header class="top-bar">DMC</header>

    <div class="app">
      <aside class="sidebar">
        <nav class="nav">
          %%[ IF @categoryRowCount > 0 THEN
               FOR @index = 1 TO @categoryRowCount DO
                 SET @categoryRow  = Row(@categoryRows, @index)
                 SET @categoryId   = Field(@categoryRow, "CategoryId")
                 SET @categoryName = Field(@categoryRow, "CategoryName")

                 /* Only mark active if a cat value was passed and it matches */
                 IF NOT EMPTY(@selectedCategoryId) AND @categoryId == @selectedCategoryId THEN
                   SET @activeClass = " active"
                 ELSE
                   SET @activeClass = ""
                 ENDIF
          ]%%
          <a href="?cat=%%=v(@categoryId)=%%"
             class="nav-link%%=v(@activeClass)=%%">
            %%=v(@categoryName)=%%
          </a>
          %%[    NEXT @index
              ENDIF
          ]%%
        </nav>
      </aside>

      <main class="main">
        <section class="card">
          <h1 class="card-title">
            %%[ IF NOT EMPTY(@selectedCategoryName) THEN ]%%
              %%=v(@selectedCategoryName)=%%
            %%[ ELSE ]%%
              All Content
            %%[ ENDIF ]%%
          </h1>

          <div class="list">
            <div class="list-header">
              <div class="list-cell">Data Extension</div>
              <div class="list-cell actions">Action</div>
            </div>

            %%[ IF @contentRowCount > 0 THEN
                 FOR @contentIndex = 1 TO @contentRowCount DO
                   SET @contentRow        = Row(@contentRows, @contentIndex)
                   SET @dataExtensionKey  = Field(@contentRow, "DataExtensionKey")
                   SET @contentCategoryId = Field(@contentRow, "CategoryId")
            ]%%
            <div class="list-row">
              <div class="list-cell">
                <!-- Later this will link to Page 2: ?cat=...&de=... -->
                <a href="href="?cat=%%=v(@categoryId)=%%?"">
                  %%=v(@dataExtensionKey)=%%
                </a>
              </div>
              <div class="list-cell actions">
                <button class="btn-link">Edit</button>
              </div>
            </div>
            %%[      NEXT @contentIndex
                ELSE ]%%
            <div class="list-row">
              <div class="list-cell">
                No content data extensions found.
              </div>
              <div class="list-cell actions"></div>
            </div>
            %%[ ENDIF ]%%
          </div>
        </section>
      </main>
    </div>
  </body>
</html>
