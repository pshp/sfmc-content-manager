<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DMC Content Manager – Page 1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://mcf3ylxg67h42hhkc8yccdpmdjt1.pub.sfmc-content.com/xos4rfhkxdn"
    />
  </head>
  <body>
  %%[

  /* Category nav data */
  SET @categoryRows = LookupOrderedRows(
    "CM_ContentCategory",
    0,
    "CreatedDate ASC",
    "Status",
    "Active"
    )
  SET @categoryRowCount = RowCount(@categoryRows)

  /* querystring params */
  SET @selectedCategoryId       = RequestParameter("cat")
  SET @selectedDataExtensionKey = RequestParameter("de")

  /* soft-delete flags for variants */
  SET @deleteFlag = RequestParameter("delete")
  SET @delCountry = RequestParameter("country")
  SET @delLang    = RequestParameter("lang")
  SET @delType    = RequestParameter("type")
  SET @delVersion = RequestParameter("version")

  /* If delete=1 and we know which DE + row, mark rows as deleted */
  IF NOT EMPTY(@selectedDataExtensionKey) AND @deleteFlag == "1" THEN

    /* 4 keys: CountryCode + LanguageCode + Type + Version */
    UpdateData(
      @selectedDataExtensionKey,
      4,
      "CountryCode",  @delCountry,
      "LanguageCode", @delLang,
      "Type",         @delType,
      "Version",      @delVersion,
      "IsDeleted",    "1"
    )

  ENDIF

  IF NOT EMPTY(@selectedCategoryId) THEN
    SET @selectedCategoryName = Lookup(
      "CM_ContentCategory",
      "CategoryName",
      "CategoryId",
      @selectedCategoryId
    )
  ENDIF

  IF NOT EMPTY(@selectedCategoryId) AND EMPTY(@selectedDataExtensionKey) THEN

    SET @contentRows = LookupOrderedRows(
      "CM_ContentDataExtension",
      0,
      "CreatedDate ASC",
      "IsDeleted", "0",
      "CategoryId", @selectedCategoryId
    )
    SET @contentRowCount = RowCount(@contentRows)
  ENDIF

  IF NOT EMPTY(@selectedDataExtensionKey) THEN

    /* Show only non-deleted rows for this content block. */
    SET @variantRows = LookupOrderedRows(
      @selectedDataExtensionKey,
      0,
      "CountryCode ASC, LanguageCode ASC, Type ASC, Version ASC",
      "IsDeleted", "0", "IsLatest", "1"
    )
    SET @variantRowCount = RowCount(@variantRows)
  ENDIF
]%%


    <header class="top-bar">DMC</header>

    <div class="app">
      <!-- LEFT NAV -->
      <aside class="sidebar">
        <nav class="nav">
          %%[ IF @categoryRowCount > 0 THEN
               FOR @index = 1 TO @categoryRowCount DO
                 SET @categoryRow  = Row(@categoryRows, @index)
                 SET @categoryId   = Field(@categoryRow, "CategoryId")
                 SET @categoryName = Field(@categoryRow, "CategoryName")

                 IF NOT EMPTY(@selectedCategoryId) AND @categoryId == @selectedCategoryId THEN
                   SET @activeClass = " active"
                 ELSE
                   SET @activeClass = ""
                 ENDIF
          ]%%
          <a href="?cat=%%=v(@categoryId)=%%"
             class="nav-link%%=v(@activeClass)=%%">
            %%=v(@categoryName)=%%
          </a>
          %%[    NEXT @index
              ENDIF
          ]%%
        </nav>
      </aside>

      <!-- main card -->
      <main class="main">
        <section class="card">
          %%[ IF NOT EMPTY(@selectedDataExtensionKey) THEN ]%%
            <!-- after selecting a content (variants list) -->

            <h1 class="card-title">
              %%[ IF NOT EMPTY(@selectedCategoryName) THEN ]%%
                %%=v(@selectedCategoryName)=%% - %%=v(@selectedDataExtensionKey)=%%
              %%[ ELSE ]%%
                %%=v(@selectedDataExtensionKey)=%%
              %%[ ENDIF ]%%
            </h1>

            <div style="text-align: right; margin-bottom: 0.5rem;">
              <a
                href="%%=IIF(EMPTY(@selectedCategoryId),'?',Concat('?cat=',@selectedCategoryId))=%%"
                class="btn-link"
              >
                ↩ zurück
              </a>
            </div>

            <table class="list" style="margin-bottom: 1rem;">
              <tbody>
                <tr>
                  <th>Data Extension:</th>
                  <td>%%=v(@selectedDataExtensionKey)=%%</td>
                </tr>
              </tbody>
            </table>

            <!-- main variants grid -->
            <table class="list">
              <thead>
                <tr>
                  <th>Country</th>
                  <th>Language</th>
                  <th>Type</th>
                  <th>Version</th>
                  <th>Number of Content Versions</th>
                  <th class="actions">Action</th>
                </tr>
              </thead>
              <tbody>
                %%[
                  IF @variantRowCount > 0 THEN

                    VAR @visibleCount
                    SET @visibleCount = 0

                    FOR @variantIndex = 1 TO @variantRowCount DO
                      SET @variantRow               = Row(@variantRows, @variantIndex)
                      SET @countryCode              = Field(@variantRow, "CountryCode")
                      SET @languageCode             = Field(@variantRow, "LanguageCode")
                      SET @variantType              = Field(@variantRow, "Type")
                      SET @variantVersion           = Field(@variantRow, "Version")
                      SET @variantContentVersion    = Field(@variantRow, "ContentVersion")
                      SET @variantStatus            = Field(@variantRow, "Status")
                      SET @variantIsLatest          = Field(@variantRow, "IsLatest")
                ]%%
                        <tr>
                          <td>%%=v(@countryCode)=%%</td>
                          <td>%%=v(@languageCode)=%%</td>
                          <td>%%=v(@variantType)=%%</td>
                          <td>%%=v(@variantVersion)=%%</td>
                          <td>%%=v(@variantContentVersion)=%%</td>
                          <td class="actions">
                            <a class="btn-link" href="#">edit</a>
                            <a class="btn-link" href="#">view</a>
                            <!-- soft delete with confirm -->
                            <a
                              class="btn-link"
                              href="?cat=%%=v(@selectedCategoryId)=%%&de=%%=v(@selectedDataExtensionKey)=%%&delete=1&country=%%=v(@countryCode)=%%&lang=%%=v(@languageCode)=%%&type=%%=v(@variantType)=%%&version=%%=v(@variantVersion)=%%"
                              onclick="return confirm('Do you really want to delete this variant?');"
                            >
                              delete
                            </a>
                          </td>
                        </tr>
                %%[
                    NEXT @variantIndex
                  ELSE
                ]%%
                    <tr>
                      <td colspan="7">No variants found.</td>
                    </tr>
                %%[ ENDIF ]%%
              </tbody>
            </table>

          %%[ ELSE ]%%
            <!-- initial view/ content DE list for category -->

            <h1 class="card-title">
              %%[ IF NOT EMPTY(@selectedCategoryName) THEN ]%%
                %%=v(@selectedCategoryName)=%%
              %%[ ELSE ]%%
                Select a category
              %%[ ENDIF ]%%
            </h1>

            %%[ IF NOT EMPTY(@selectedCategoryId) THEN ]%%
              <!-- Only show the table once a category is chosen -->
              <table class="list">
                <thead>
                  <tr>
                    <th>Data Extension</th>
                    <th class="actions">Action</th>
                  </tr>
                </thead>
                <tbody>
                  %%[ IF @contentRowCount > 0 THEN
                       FOR @contentIndex = 1 TO @contentRowCount DO
                         SET @contentRow       = Row(@contentRows, @contentIndex)
                         SET @dataExtensionKey = Field(@contentRow, "DataExtensionKey")
                  ]%%
                    <tr>
                      <td>
                        <a href="?cat=%%=v(@selectedCategoryId)=%%&de=%%=v(@dataExtensionKey)=%%">
                          %%=v(@dataExtensionKey)=%%
                        </a>
                      </td>
                      <td class="actions">
                        <a href="?cat=%%=v(@selectedCategoryId)=%%&de=%%=v(@dataExtensionKey)=%%" class="btn-link">
                          edit
                        </a>
                      </td>
                    </tr>
                  %%[ NEXT @contentIndex ELSE ]%%
                    <tr>
                      <td colspan="2">
                        No content data extensions found for this category.
                      </td>
                    </tr>
                  %%[ ENDIF ]%%
                </tbody>
              </table>
            %%[ ELSE ]%%
              <!-- no category yet -->
              <p>Please select a category from the left to see its content data extensions.</p>
            %%[ ENDIF ]%%

          %%[ ENDIF ]%%
        </section>
      </main>
    </div>
  </body>
</html>
