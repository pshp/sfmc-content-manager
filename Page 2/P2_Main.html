%%[
  /* ------------------------------------------------------------------
     Page 2: Edit a single content variant (all ContentVersions)
     ------------------------------------------------------------------
     URL / form parameters
     ------------------------------------------------------------------
     Context:
       cat      = CategoryId
       de       = DataExtensionKey
       country  = CountryCode
       lang     = LanguageCode
       type     = Type
       version  = Version

     Version / action:
       cv       = target ContentVersion (also "current CV")
       id       = _CustomObjectKey for the selected row (required for actions)
       action   = 'activate' | 'deactivate' | 'save'

     Behaviour:
       - activate:   make one CV Active, others Inactive for this variant
       - deactivate: set this CV to Inactive
       - save:       update fields for the selected CV (by _CustomObjectKey)
     ------------------------------------------------------------------ */

  /* --------------------------------------------------
     1) Querystring: variant + DE context
     -------------------------------------------------- */
  SET @selectedCategoryId       = RequestParameter("cat")
  SET @selectedDataExtensionKey = RequestParameter("de")
  SET @countryCode              = RequestParameter("country")
  SET @languageCode             = RequestParameter("lang")
  SET @variantType              = RequestParameter("type")
  SET @variantVersion           = RequestParameter("version")

  /* --------------------------------------------------
     2) Querystring / form: action + target CV + row id
     -------------------------------------------------- */
  SET @action   = RequestParameter("action")  /* 'activate', 'deactivate', 'save' */
  SET @targetCv = RequestParameter("cv")      /* target ContentVersion ("current cv") */
  SET @rowId    = RequestParameter("id")      /* _CustomObjectKey (row identity) */

  /* --------------------------------------------------
     3) Lookups: category name + field config
     -------------------------------------------------- */
  SET @selectedCategoryName = ""

  /* Category name (for title) */
  IF NOT EMPTY(@selectedCategoryId) THEN
    SET @selectedCategoryName = Lookup(
      "CM_ContentCategory",
      "CategoryName",
      "CategoryId",
      @selectedCategoryId
    )
  ENDIF

  /* Field configuration for this DE (drives form + save) */
  SET @contentFieldRows = LookupOrderedRows(
    "CM_ContentFieldConfig",
    0,
    "SortOrder ASC",
    "DataExtensionKey",
    @selectedDataExtensionKey
  )
  SET @contentFieldCount = RowCount(@contentFieldRows)

  /* --------------------------------------------------
     4) Initialise counters / state variables
     -------------------------------------------------- */
  SET @rowsUpdated          = 0

  /* Version / CV state that will be filled AFTER actions */
  SET @versionRowCount      = 0
  SET @latestContentVersion = ""
  SET @latestStatus         = ""
  SET @activeContentVersion = ""
  SET @contentVersion       = ""
  SET @currentRow           = ""
  SET @currentStatus           = ""

  /* ==================================================================
     5) HANDLE ACTIONS: ACTIVATE / DEACTIVATE / SAVE (update current CV)
     ================================================================== */
  IF NOT EMPTY(@action) AND
     NOT EMPTY(@selectedDataExtensionKey) AND
     NOT EMPTY(@countryCode) AND NOT EMPTY(@languageCode) AND
     NOT EMPTY(@variantType) AND NOT EMPTY(@variantVersion) THEN

    /* ------------------------------------------
       5a) ACTIVATE: make one CV Active
       ------------------------------------------ */
    IF @action == "activate" AND NOT EMPTY(@targetCv) AND NOT EMPTY(@rowId) THEN

      /* Deactivate any currently Active versions for this variant */
      SET @activeRows = LookupRows(
        @selectedDataExtensionKey,
        "IsDeleted",   "0",
        "CountryCode",  @countryCode,
        "LanguageCode", @languageCode,
        "Type",         @variantType,
        "Version",      @variantVersion,
        "Status",       "Active"
      )
      SET @activeCount = RowCount(@activeRows)

      IF @activeCount > 0 THEN
        FOR @i = 1 TO @activeCount DO
          SET @row = Row(@activeRows, @i)
          SET @cv  = Field(@row, "ContentVersion")

          UpdateData(
            @selectedDataExtensionKey,
            5,
            "CountryCode",     @countryCode,
            "LanguageCode",    @languageCode,
            "Type",            @variantType,
            "Version",         @variantVersion,
            "ContentVersion",  @cv,
            "Status",          "Inactive",
            "ModifiedDate",    Now()
          )
        NEXT @i
      ENDIF

      /* Now set target version to Active (by identity) */
      UpdateData(
        @selectedDataExtensionKey,
        1,
        "_CustomObjectKey", @rowId,
        "Status",           "Active",
        "ModifiedDate",     Now()
      )

    /* ------------------------------------------
       5b) DEACTIVATE: set specific CV to Inactive
       ------------------------------------------ */
    ELSEIF @action == "deactivate" AND NOT EMPTY(@rowId) THEN

      UpdateData(
        @selectedDataExtensionKey,
        1,
        "_CustomObjectKey", @rowId,
        "Status",           "Inactive",
        "ModifiedDate",     Now()
      )

    /* ------------------------------------------
       5c) SAVE: update fields on the selected CV
       ------------------------------------------ */
    ELSEIF @action == "save" THEN

      /* 5c-0: Which CV are we saving? Prefer cv from URL/form */
      SET @saveCv = @targetCv

      IF EMPTY(@saveCv) THEN
        /* Fallback: use latest CV as base */
        SET @latestRows = LookupOrderedRows(
          @selectedDataExtensionKey,
          1,
          "ContentVersion DESC",
          "IsDeleted",   "0",
          "CountryCode",  @countryCode,
          "LanguageCode", @languageCode,
          "Type",         @variantType,
          "Version",      @variantVersion
        )

        IF RowCount(@latestRows) > 0 THEN
          SET @latestRow = Row(@latestRows, 1)
          SET @saveCv    = Field(@latestRow, "ContentVersion")
        ENDIF
      ENDIF

      /* 5c-1: Check status of the CV we’re saving */
      SET @saveStatus = ""

      IF NOT EMPTY(@saveCv) THEN

        SET @saveRows = LookupRows(
          @selectedDataExtensionKey,
          "IsDeleted",     "0",
          "CountryCode",   @countryCode,
          "LanguageCode",  @languageCode,
          "Type",          @variantType,
          "Version",       @variantVersion,
          "ContentVersion", @saveCv
        )

        IF RowCount(@saveRows) > 0 THEN
          SET @saveRow    = Row(@saveRows, 1)
          SET @saveStatus = Field(@saveRow, "Status")
        ENDIF

      ENDIF

      /* --------------------------------------------------
         CASE 1: current version is Draft → update in place
         -------------------------------------------------- */
      IF @saveStatus == "Draft" THEN

        /* Update all configured fields on this Draft row */
        IF @contentFieldCount > 0 THEN

          FOR @sf = 1 TO @contentFieldCount DO
            SET @saveFieldRow  = Row(@contentFieldRows, @sf)
            SET @saveFieldName = Field(@saveFieldRow, "FieldName")
            SET @saveValue     = RequestParameter(@saveFieldName)

            IF NOT EMPTY(@saveFieldName) THEN
              SET @r = UpdateData(
                @selectedDataExtensionKey,
                5,
                "CountryCode",    @countryCode,
                "LanguageCode",   @languageCode,
                "Type",           @variantType,
                "Version",        @variantVersion,
                "ContentVersion", @saveCv,
                @saveFieldName,   @saveValue
              )
              SET @rowsUpdated = Add(@rowsUpdated, @r)
            ENDIF
          NEXT @sf

        ENDIF

        /* Update ModifiedDate on the same Draft row */
        UpdateData(
          @selectedDataExtensionKey,
          5,
          "CountryCode",    @countryCode,
          "LanguageCode",   @languageCode,
          "Type",           @variantType,
          "Version",        @variantVersion,
          "ContentVersion", @saveCv,
          "ModifiedDate",   Now()
        )

        /* Keep editing this same CV */
        SET @targetCv = @saveCv

      /* --------------------------------------------------
         CASE 2: not Draft (Active/Inactive) → create new CV
         -------------------------------------------------- */
      ELSE

        /* 5c-NEW-1: find latest CV number */
        SET @latestCv   = 0
        SET @latestRows = LookupOrderedRows(
          @selectedDataExtensionKey,
          1,
          "ContentVersion DESC",
          "IsDeleted",   "0",
          "CountryCode",  @countryCode,
          "LanguageCode", @languageCode,
          "Type",         @variantType,
          "Version",      @variantVersion
        )

        IF RowCount(@latestRows) > 0 THEN
          SET @latestRow = Row(@latestRows, 1)
          SET @latestCv  = Field(@latestRow, "ContentVersion")
        ENDIF

        /* 5c-NEW-2: new CV = latest + 1 */
        SET @newCv = Add(@latestCv, 1)

        /* 5c-NEW-3: insert skeleton row for new Draft version */
        SET @insertCount = InsertData(
          @selectedDataExtensionKey,
          "CountryCode",    @countryCode,
          "LanguageCode",   @languageCode,
          "Type",           @variantType,
          "Version",        @variantVersion,
          "ContentVersion", @newCv,
          "Status",         "Draft",
          "IsDeleted",      "0",
          "CreatedDate",    Now(),
          "ModifiedDate",   Now()
        )

        /* 5c-NEW-4: populate all configured fields on the new CV */
        IF @contentFieldCount > 0 THEN

          FOR @sf = 1 TO @contentFieldCount DO
            SET @saveFieldRow  = Row(@contentFieldRows, @sf)
            SET @saveFieldName = Field(@saveFieldRow, "FieldName")
            SET @saveValue     = RequestParameter(@saveFieldName)

            IF NOT EMPTY(@saveFieldName) THEN
              SET @r = UpdateData(
                @selectedDataExtensionKey,
                5,
                "CountryCode",    @countryCode,
                "LanguageCode",   @languageCode,
                "Type",           @variantType,
                "Version",        @variantVersion,
                "ContentVersion", @newCv,
                @saveFieldName,   @saveValue
              )
              SET @rowsUpdated = Add(@rowsUpdated, @r)
            ENDIF
          NEXT @sf

        ENDIF

        /* 5c-NEW-5: continue editing the new version */
        SET @targetCv = @newCv

      ENDIF  /* end draft vs new */

      /* 5c-X: Redirect so UI reloads with the saved CV */
      SET @redirectUrl = Concat(
        CloudPagesURL(3638),
        '?cat=',     @selectedCategoryId,
        '&de=',      @selectedDataExtensionKey,
        '&country=', @countryCode,
        '&lang=',    @languageCode,
        '&type=',    @variantType,
        '&version=', @variantVersion,
        '&cv=',      @targetCv
      )

      Redirect(@redirectUrl)

    ENDIF /* end save */
  ENDIF   /* end action guard */

  /* ==================================================================
     6) AFTER ACTIONS: load versions + decide which CV to edit
     ================================================================== */
  IF NOT EMPTY(@selectedDataExtensionKey) AND NOT EMPTY(@countryCode) AND
     NOT EMPTY(@languageCode) AND NOT EMPTY(@variantType) AND NOT EMPTY(@variantVersion) THEN

    /* 0 = all rows */
    SET @versionRows = LookupOrderedRows(
      @selectedDataExtensionKey,
      0,
      "ContentVersion DESC",
      "IsDeleted",   "0",
      "CountryCode",  @countryCode,
      "LanguageCode", @languageCode,
      "Type",         @variantType,
      "Version",      @variantVersion
    )
    SET @versionRowCount = RowCount(@versionRows)

    /* Latest version = first row in DESC list */
    IF @versionRowCount > 0 THEN
      SET @latestRow            = Row(@versionRows, 1)
      SET @latestContentVersion = Field(@latestRow, "ContentVersion")
      SET @latestStatus         = Field(@latestRow, "Status")
    ENDIF

    /* Active CV (if any) */
    SET @activeRows = LookupOrderedRows(
      @selectedDataExtensionKey,
      1,
      "ContentVersion DESC",
      "IsDeleted",   "0",
      "CountryCode",  @countryCode,
      "LanguageCode", @languageCode,
      "Type",         @variantType,
      "Version",      @variantVersion,
      "Status",       "Active"
    )

    IF RowCount(@activeRows) > 0 THEN
      SET @activeRow            = Row(@activeRows, 1)
      SET @activeContentVersion = Field(@activeRow, "ContentVersion")

    ENDIF

    /* Decide which CV is the one we are currently editing */
    IF NOT EMPTY(@targetCv) THEN
      /* 1) Explicit cv in URL / form */
      SET @contentVersion = @targetCv
    ELSEIF NOT EMPTY(@activeContentVersion) THEN
      /* 2) Prefer active version */
      SET @contentVersion = @activeContentVersion
    ELSE
      /* 3) Fallback: latest */
      SET @contentVersion = @latestContentVersion
    ENDIF

    /* Load the row for the current CV we are editing (still by variant keys) */
    IF NOT EMPTY(@contentVersion) THEN
      SET @currentRows = LookupRows(
        @selectedDataExtensionKey,
        "IsDeleted",     "0",
        "CountryCode",   @countryCode,
        "LanguageCode",  @languageCode,
        "Type",          @variantType,
        "Version",       @variantVersion,
        "ContentVersion", @contentVersion
      )

      IF RowCount(@currentRows) > 0 THEN
        SET @currentRow = Row(@currentRows, 1)
        SET @currentStatus = Field(@currentRow, "Status")
      ENDIF
    ENDIF
  ENDIF
]%%

%%=ContentBlockByKey("DMC_P2_VariantEdit_Header")=%%
%%=ContentBlockByKey("DMC_P2_VariantEdit_Form")=%%
%%=ContentBlockByKey("DMC_P2_VariantEdit_History")=%%
