%%[
  /* --- Page 2: Edit a single content variant (all ContentVersions) -- */

  /* 1) Querystring: variant + DE context */
  SET @selectedCategoryId       = RequestParameter("cat")
  SET @selectedDataExtensionKey = RequestParameter("de")
  SET @countryCode              = RequestParameter("country")
  SET @languageCode             = RequestParameter("lang")
  SET @variantType              = RequestParameter("type")
  SET @variantVersion           = RequestParameter("version")

  /* 2) Querystring: action + target CV + row id */
  SET @action   = RequestParameter("action")  /* activate | deactivate | save */
  SET @targetCv = RequestParameter("cv")
  SET @rowId    = RequestParameter("id")      /* _CustomObjectKey */

  /* 3) Category + field config */
  SET @selectedCategoryName = ""

  IF NOT EMPTY(@selectedCategoryId) THEN
    SET @selectedCategoryName = Lookup(
      "DMC_ContentCategory",
      "CategoryName",
      "CategoryId",
      @selectedCategoryId
    )
  ENDIF

  SET @contentFieldRows = LookupOrderedRows(
    "DMC_ContentFieldConfig",
    0,
    "SortOrder ASC",
    "DataExtensionKey",
    @selectedDataExtensionKey
  )
  SET @contentFieldCount = RowCount(@contentFieldRows)

  /* 4) Output / state defaults */
  SET @rowsUpdated          = 0
  SET @versionRowCount      = 0
  SET @latestContentVersion = ""
  SET @latestStatus         = ""
  SET @activeContentVersion = ""
  SET @contentVersion       = ""
  SET @currentRow           = ""
  SET @currentStatus        = ""

  /* 5) Actions: activate / deactivate / save */
  IF NOT EMPTY(@action) AND
     NOT EMPTY(@selectedDataExtensionKey) AND
     NOT EMPTY(@countryCode) AND NOT EMPTY(@languageCode) AND
     NOT EMPTY(@variantType) AND NOT EMPTY(@variantVersion) THEN

    /* 5a) Activate: make one CV Active */
    IF @action == "activate" AND NOT EMPTY(@targetCv) AND NOT EMPTY(@rowId) THEN

      /* Deactivate current Active versions for this variant */
      SET @activeRows = LookupRows(
        @selectedDataExtensionKey,
        "IsDeleted",   "0",
        "CountryCode",  @countryCode,
        "LanguageCode", @languageCode,
        "Type",         @variantType,
        "Version",      @variantVersion,
        "Status",       "Active"
      )
      SET @activeCount = RowCount(@activeRows)

      IF @activeCount > 0 THEN
        FOR @i = 1 TO @activeCount DO
          SET @row = Row(@activeRows, @i)
          SET @cv  = Field(@row, "ContentVersion")

          UpdateData(
            @selectedDataExtensionKey,
            5,
            "CountryCode",     @countryCode,
            "LanguageCode",    @languageCode,
            "Type",            @variantType,
            "Version",         @variantVersion,
            "ContentVersion",  @cv,
            "Status",          "Inactive",
            "ModifiedDate",    Now()
          )
        NEXT @i
      ENDIF

      /* Set target row to Active (by identity) */
      UpdateData(
        @selectedDataExtensionKey,
        1,
        "_CustomObjectKey", @rowId,
        "Status",           "Active",
        "ModifiedDate",     Now()
      )

    /* 5b) Deactivate: set specific CV to Inactive */
    ELSEIF @action == "deactivate" AND NOT EMPTY(@rowId) THEN

      UpdateData(
        @selectedDataExtensionKey,
        1,
        "_CustomObjectKey", @rowId,
        "Status",           "Inactive",
        "ModifiedDate",     Now()
      )

    /* 5c) Save: update or create ContentVersion */
    ELSEIF @action == "save" THEN

      /* 5c-1: which CV are we saving? */
      SET @saveCv = @targetCv

      IF EMPTY(@saveCv) THEN
        /* fallback: latest CV */
        SET @latestRows = LookupOrderedRows(
          @selectedDataExtensionKey,
          1,
          "ContentVersion DESC",
          "IsDeleted",   "0",
          "CountryCode",  @countryCode,
          "LanguageCode", @languageCode,
          "Type",         @variantType,
          "Version",      @variantVersion
        )

        IF RowCount(@latestRows) > 0 THEN
          SET @latestRow = Row(@latestRows, 1)
          SET @saveCv    = Field(@latestRow, "ContentVersion")
        ENDIF
      ENDIF

      /* 5c-2: status of the CV we’re saving */
      SET @saveStatus = ""

      IF NOT EMPTY(@saveCv) THEN

        SET @saveRows = LookupRows(
          @selectedDataExtensionKey,
          "IsDeleted",     "0",
          "CountryCode",   @countryCode,
          "LanguageCode",  @languageCode,
          "Type",          @variantType,
          "Version",       @variantVersion,
          "ContentVersion", @saveCv
        )

        IF RowCount(@saveRows) > 0 THEN
          SET @saveRow    = Row(@saveRows, 1)
          SET @saveStatus = Field(@saveRow, "Status")
        ENDIF

      ENDIF

      /* 5c-3: Draft → update in place */
      IF @saveStatus == "Draft" THEN

        IF @contentFieldCount > 0 THEN
          FOR @sf = 1 TO @contentFieldCount DO
            SET @saveFieldRow  = Row(@contentFieldRows, @sf)
            SET @saveFieldName = Field(@saveFieldRow, "FieldName")
            SET @saveValue     = RequestParameter(@saveFieldName)

            IF NOT EMPTY(@saveFieldName) THEN
              SET @r = UpdateData(
                @selectedDataExtensionKey,
                5,
                "CountryCode",    @countryCode,
                "LanguageCode",   @languageCode,
                "Type",           @variantType,
                "Version",        @variantVersion,
                "ContentVersion", @saveCv,
                @saveFieldName,   @saveValue
              )
              SET @rowsUpdated = Add(@rowsUpdated, @r)
            ENDIF
          NEXT @sf
        ENDIF

        /* update ModifiedDate on same Draft row */
        UpdateData(
          @selectedDataExtensionKey,
          5,
          "CountryCode",    @countryCode,
          "LanguageCode",   @languageCode,
          "Type",           @variantType,
          "Version",        @variantVersion,
          "ContentVersion", @saveCv,
          "ModifiedDate",   Now()
        )

        SET @targetCv = @saveCv

      /* 5c-4: Active/Inactive → create new Draft CV */
      ELSE

        /* latest CV number */
        SET @latestCv   = 0
        SET @latestRows = LookupOrderedRows(
          @selectedDataExtensionKey,
          1,
          "ContentVersion DESC",
          "IsDeleted",   "0",
          "CountryCode",  @countryCode,
          "LanguageCode", @languageCode,
          "Type",         @variantType,
          "Version",      @variantVersion
        )

        IF RowCount(@latestRows) > 0 THEN
          SET @latestRow = Row(@latestRows, 1)
          SET @latestCv  = Field(@latestRow, "ContentVersion")
        ENDIF

        SET @newCv = Add(@latestCv, 1)

        /* new Draft row */
        SET @insertCount = InsertData(
          @selectedDataExtensionKey,
          "CountryCode",    @countryCode,
          "LanguageCode",   @languageCode,
          "Type",           @variantType,
          "Version",        @variantVersion,
          "ContentVersion", @newCv,
          "Status",         "Draft",
          "IsDeleted",      "0",
          "CreatedDate",    Now(),
          "ModifiedDate",   Now()
        )

        /* populate fields for new CV */
        IF @contentFieldCount > 0 THEN
          FOR @sf = 1 TO @contentFieldCount DO
            SET @saveFieldRow  = Row(@contentFieldRows, @sf)
            SET @saveFieldName = Field(@saveFieldRow, "FieldName")
            SET @saveValue     = RequestParameter(@saveFieldName)

            IF NOT EMPTY(@saveFieldName) THEN
              SET @r = UpdateData(
                @selectedDataExtensionKey,
                5,
                "CountryCode",    @countryCode,
                "LanguageCode",   @languageCode,
                "Type",           @variantType,
                "Version",        @variantVersion,
                "ContentVersion", @newCv,
                @saveFieldName,   @saveValue
              )
              SET @rowsUpdated = Add(@rowsUpdated, @r)
            ENDIF
          NEXT @sf
        ENDIF

        SET @targetCv = @newCv

      ENDIF  /* Draft vs new */

      /* 5c-5: redirect so UI reloads with saved CV */
      SET @redirectUrl = CloudPagesURL(
                        @page2,
                        "cat",     @selectedCategoryId,
                        "de",      @selectedDataExtensionKey,
                        "country", @countryCode,
                        "lang",    @languageCode,
                        "type",    @variantType,
                        "version", @variantVersion,
                        "cv",      @targetCv
                      )

      Redirect(@redirectUrl)

    ENDIF /* action = save */
  ENDIF   /* action guard */

  /* 6) After actions: load versions + pick current CV */
  IF NOT EMPTY(@selectedDataExtensionKey) AND NOT EMPTY(@countryCode) AND
     NOT EMPTY(@languageCode) AND NOT EMPTY(@variantType) AND NOT EMPTY(@variantVersion) THEN

    /* all CVs for this variant */
    SET @versionRows = LookupOrderedRows(
      @selectedDataExtensionKey,
      0,
      "ContentVersion DESC",
      "IsDeleted",   "0",
      "CountryCode",  @countryCode,
      "LanguageCode", @languageCode,
      "Type",         @variantType,
      "Version",      @variantVersion
    )
    SET @versionRowCount = RowCount(@versionRows)

    IF @versionRowCount > 0 THEN
      SET @latestRow            = Row(@versionRows, 1)
      SET @latestContentVersion = Field(@latestRow, "ContentVersion")
      SET @latestStatus         = Field(@latestRow, "Status")
    ENDIF

    /* active CV (if any) */
    SET @activeRows = LookupOrderedRows(
      @selectedDataExtensionKey,
      1,
      "ContentVersion DESC",
      "IsDeleted",   "0",
      "CountryCode",  @countryCode,
      "LanguageCode", @languageCode,
      "Type",         @variantType,
      "Version",      @variantVersion,
      "Status",       "Active"
    )

    IF RowCount(@activeRows) > 0 THEN
      SET @activeRow            = Row(@activeRows, 1)
      SET @activeContentVersion = Field(@activeRow, "ContentVersion")
    ENDIF

    /* current CV to edit */
    IF NOT EMPTY(@targetCv) THEN
      SET @contentVersion = @targetCv
    ELSEIF NOT EMPTY(@activeContentVersion) THEN
      SET @contentVersion = @activeContentVersion
    ELSE
      SET @contentVersion = @latestContentVersion
    ENDIF

    /* row for current CV */
    IF NOT EMPTY(@contentVersion) THEN
      SET @currentRows = LookupRows(
        @selectedDataExtensionKey,
        "IsDeleted",     "0",
        "CountryCode",   @countryCode,
        "LanguageCode",  @languageCode,
        "Type",          @variantType,
        "Version",       @variantVersion,
        "ContentVersion", @contentVersion
      )

      IF RowCount(@currentRows) > 0 THEN
        SET @currentRow    = Row(@currentRows, 1)
        SET @currentStatus = Field(@currentRow, "Status")
      ENDIF
    ENDIF
  ENDIF
]%%

%%=ContentBlockByKey("DMC_P2_VariantEdit_Header")=%%
%%=ContentBlockByKey("DMC_P2_VariantEdit_Form")=%%
%%=ContentBlockByKey("DMC_P2_VariantEdit_History")=%%
