%%[
  /* --- Insert + validation --- */

  SET @message     = ""
  SET @messageType = "" /* error | info | success */
  SET @messageBg   = ""

  IF @addVariant == "1" THEN

    /* Read form values only when popup is active */
    SET @newLocale  = RequestParameter("newLocale")
    SET @newType    = RequestParameter("newType")
    SET @newVersion = RequestParameter("newVersion")
    SET @reactivate = RequestParameter("reactivate")

    /* Sticky selections */
    SET @selectedLocale  = @newLocale
    SET @selectedType    = @newType
    SET @selectedVersion = @newVersion

    /* Full trio provided → validate / act */
    IF NOT EMPTY(@newLocale) AND NOT EMPTY(@newType) AND NOT EMPTY(@newVersion) THEN

      /* Parse "CC|LL" */
      SET @localeParts = BuildRowsetFromString(@newLocale, "|")
      SET @newCountry  = ""
      SET @newLanguage = ""

      IF RowCount(@localeParts) >= 2 THEN
        SET @newCountry  = Field(Row(@localeParts, 1), 1)
        SET @newLanguage = Field(Row(@localeParts, 2), 1)
      ENDIF

      IF NOT EMPTY(@selectedDataExtensionKey) AND NOT EMPTY(@newCountry) AND NOT EMPTY(@newLanguage) THEN

        /* Does this variant already exist? (no need for ordering) */
        SET @existingRows = LookupRows(
          @selectedDataExtensionKey,
          "CountryCode",  @newCountry,
          "LanguageCode", @newLanguage,
          "Type",         @newType,
          "Version",      @newVersion
        )
        SET @existingCount = RowCount(@existingRows)

        IF @existingCount == 0 THEN

          /* Create new variant */
          InsertDE(
            @selectedDataExtensionKey,
            "CountryCode",     @newCountry,
            "LanguageCode",    @newLanguage,
            "Type",            @newType,
            "Version",         @newVersion,
            "ContentVersion",  "1",
            "IsDeleted",       "0"
          )

          SET @message     = "Variant created successfully."
          SET @messageType = "success"

        ELSE

          /* Existing variant */
          SET @existingRow    = Row(@existingRows, 1)
          SET @existingStatus = Field(@existingRow, "IsDeleted")

          IF @existingStatus == "1" THEN

            IF @reactivate == "1" THEN

              /* Reactivate soft-deleted variant */
              UpdateData(
                @selectedDataExtensionKey,
                4,
                "CountryCode",  @newCountry,
                "LanguageCode", @newLanguage,
                "Type",         @newType,
                "Version",      @newVersion,
                "IsDeleted",    "0"
              )

              SET @message     = "Variant reactivated."
              SET @messageType = "success"

            ELSE

              /* Ask for reactivation */
              SET @message     = "This variant exists but has been deleted. Do you want to reactivate it?"
              SET @messageType = "info"

            ENDIF

          ELSE

            /* Active variant already exists */
            SET @message     = "This variant already exists for this Data Extension."
            SET @messageType = "error"

          ENDIF

        ENDIF

      ELSE

        SET @message     = "Please select a valid locale, type and version."
        SET @messageType = "error"

      ENDIF

    /* Some input but not all three → validation error */
    ELSEIF NOT EMPTY(@newLocale) OR NOT EMPTY(@newType) OR NOT EMPTY(@newVersion) THEN

      SET @message     = "Please select a locale, type and version."
      SET @messageType = "error"

    ENDIF

  ENDIF

  /* Decide background color for the message (super simple) */
  IF @messageType == "error" THEN
    SET @messageBg = "#ffe5e5"
  ELSEIF @messageType == "success" THEN
    SET @messageBg = "#e5ffe8"
  ELSEIF @messageType == "info" THEN
    SET @messageBg = "#e5f0ff"
  ENDIF

  /* --- Dropdown data --- */

  SET @localeRows = LookupOrderedRows(
    "DMC_Locale",
    0,
    "IsDefault DESC, CountryCode ASC, LanguageCode ASC",
    "IsDeleted", "0"
  )
  SET @localeCount = RowCount(@localeRows)

  SET @versionRows = LookupOrderedRows(
    "DMC_Version",
    0,
    "Version ASC",
    "IsDeleted", "0"
  )
  SET @versionCount = RowCount(@versionRows)

  SET @typeRows = LookupOrderedRows(
    "DMC_Type",
    0,
    "Type ASC",
    "IsDeleted", "0"
  )
  SET @typeCount = RowCount(@typeRows)

]%%

%%[ IF @addVariant == "1" THEN ]%%
<div class="modal-overlay">
  <div class="modal">
    <h2>Add New Variant</h2>
    <p>Select locale, type and version for the new variant.</p>

    %%[ IF NOT EMPTY(@message) THEN ]%%
      <div
        class="modal-message
              %%=IIF(@messageType == 'error','modal-message--error','')=%%
              %%=IIF(@messageType == 'success','modal-message--success','')=%%
              %%=IIF(@messageType == 'info','modal-message--info','')=%%"
      >
        %%=v(@message)=%%
      </div>
    %%[ ENDIF ]%%

    <form method="get" action="">
      <input type="hidden" name="cat" value="%%=v(@selectedCategoryId)=%%" />
      <input type="hidden" name="de"  value="%%=v(@selectedDataExtensionKey)=%%" />
      <input type="hidden" name="addVariant" value="1" />

      <!-- Locale -->
      <div class="modal-field">
        <label for="newLocale">
          Locale (Country &amp; Language)
        </label>
        <select id="newLocale" name="newLocale" class="modal-select">
          %%[
            IF @localeCount > 0 THEN
              FOR @i = 1 TO @localeCount DO
                SET @locRow     = Row(@localeRows, @i)
                SET @locCountry = Field(@locRow, "CountryCode")
                SET @locLang    = Field(@locRow, "LanguageCode")
                SET @optionVal  = Concat(@locCountry, "|", @locLang)
          ]%%
          <option
            value="%%=v(@optionVal)=%%"
            %%[ IF @selectedLocale == @optionVal THEN ]%%selected="selected"%%[ ENDIF ]%%
          >
            %%=v(@locCountry)=%% - %%=v(@locLang)=%%
          </option>
          %%[ NEXT @i ENDIF ]%%
        </select>
      </div>

      <!-- Type -->
      <div class="modal-field">
        <label for="newType">
          Type
        </label>
        <select id="newType" name="newType" class="modal-select">
          <option value="">– select –</option>
          %%[
            IF @typeCount > 0 THEN
              FOR @t = 1 TO @typeCount DO
                SET @typeRow   = Row(@typeRows, @t)
                SET @typeValue = Field(@typeRow, "Type")
          ]%%
          <option
            value="%%=v(@typeValue)=%%"
            %%[ IF @selectedType == @typeValue THEN ]%%selected="selected"%%[ ENDIF ]%%
          >
            %%=v(@typeValue)=%%
          </option>
          %%[ NEXT @t ENDIF ]%%
        </select>
      </div>

      <!-- Version -->
      <div class="modal-field">
        <label for="newVersion">
          Version
        </label>
        <select id="newVersion" name="newVersion" class="modal-select">
          <option value="">– select –</option>
          %%[
            IF @versionCount > 0 THEN
              FOR @v = 1 TO @versionCount DO
                SET @verRow       = Row(@versionRows, @v)
                SET @versionValue = Field(@verRow, "Version")
          ]%%
          <option
            value="%%=v(@versionValue)=%%"
            %%[ IF @selectedVersion == @versionValue THEN ]%%selected="selected"%%[ ENDIF ]%%
          >
            %%=v(@versionValue)=%%
          </option>
          %%[ NEXT @v ENDIF ]%%
        </select>
      </div>

      <div class="modal-footer">
        <a
          class="btn-link"
          href="%%=Concat('?cat=', @selectedCategoryId, '&de=', @selectedDataExtensionKey)=%%"
        >
          Close
      </a>

        %%[ IF @messageType == "info" THEN ]%%
          <button
            type="submit"
            name="reactivate"
            value="1"
            class="btn btn-secondary"
          >
            Reactivate
          </button>
        %%[ ELSE ]%%
          <button type="submit" class="btn btn-secondary">
            Next
          </button>
        %%[ ENDIF ]%%
      </div>
    </form>
  </div>
</div>
%%[ ENDIF ]%%
